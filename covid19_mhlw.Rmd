---
title: "Covid19, Japan"
output:
  html_document:
    df_print: paged
    theme: cerulean
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
require(tidyverse)
require(jsonlite)
```

日本の新型コロナウィルスに関する情報が抱える大きな問題は、ソースごとに値が微妙にことなっていることです。原因は明白で、総元締めであるはずの厚生労働省が各自治からの患者データを集計せずに各自治体のプレスリリースやウェブサイトの数値を積上げたものを発表していることにあります。  
本来であれば医療機関->市町村->都道府県->厚生労働省の順で患者のデータを全て吸い上げて集計すべきなのです。



# 厚生労働省データ
厚生労働省の[オープンデータ](https://www.mhlw.go.jp/stf/covid-19/open-data.html)のページで公開しているデータは、あくまでも、**「国内事例」**のみであり、チャーター便、空港検疫、外国船籍の客船を除くデータになっている。なお、データによっては途中からデータソースが変更されているものがある。

　  

## Import
項目ごとのCSVファイルになっているため、個々に読み込む。

　  

### 陽性確定者数
「陽性者数」のデータ。ここでは、全て陽性確定者と表記する。厚生労働省が公開している陽性確定者数のデータは単日のデータのみ。
```{r}
"https://www.mhlw.go.jp/content/pcr_positive_daily.csv" %>% 
  readr::read_csv()
```

　  

### 死亡者数
死亡者数のデータは、なぜか累計データだけが公開されている。
```{r}
"https://www.mhlw.go.jp/content/death_total.csv" %>% 
  readr::read_csv()
```

　  

### 入院治療等を要する者の数
いわゆる無症状患者などの軽症患者を除く陽性確定者の数。各報告日時点の集計値となっている。
```{r}
"https://www.mhlw.go.jp/content/cases_total.csv" %>% 
  readr::read_csv()
```

　  

## Wrangring (tidy and transform)
各データを扱いやすいように変換する。

### 陽性確定者数
単日のデータなので累計データを求める。なお、記録漏れがあっても対処できるように日付の補完を行う。
```{r}
df_mhlw <- "https://www.mhlw.go.jp/content/pcr_positive_daily.csv" %>% 
  readr::read_csv() %>% 
  dplyr::mutate(date = lubridate::as_date(`日付`)) %>% 
  tidyr::complete(date = seq.Date(from = min(date), to = max(date), by = "day")) %>% 
  dplyr::mutate(n = as.integer(`PCR 検査陽性者数(単日)`),
                cum = cumsum(n)) %>% 
  dplyr::select(date, n, cum)

df_mhlw
```

　  

### 死亡者数
陽性確定者数とは逆に短日の数値を求める。
```{r}
dead_mhlw <- "https://www.mhlw.go.jp/content/death_total.csv" %>% 
  readr::read_csv() %>% 
  dplyr::mutate(date = lubridate::as_date(`日付`)) %>% 
  tidyr::complete(date = seq.Date(from = min(date), to = max(date), by = "day")) %>% 
  dplyr::mutate(cum_dead = as.integer(`死亡者数`),
                dead = cum_dead - dplyr::lag(cum_dead, default = 0)) %>% 
  dplyr::select(date, dead, cum_dead)

dead_mhlw
```

### 入院治療等を要する者の数
各報告日時点の集計値。
```{r}
patient_mhlw <- "https://www.mhlw.go.jp/content/cases_total.csv" %>% 
  readr::read_csv() %>% 
  dplyr::mutate(date = lubridate::as_date(`日付`)) %>% 
  tidyr::complete(date = seq.Date(from = min(date), to = max(date), by = "day")) %>% 
  dplyr::mutate(patient = as.integer(`入院治療を要する者`)) %>% 
  dplyr::select(date, patient)
patient_mhlw
```

　  

### 結合
上記のデータフレームをひとつにまとめる。
```{r}
x_mhlw <- df_mhlw %>% 
  dplyr::left_join(dead_mhlw, by = c("date")) %>% 
  dplyr::left_join(patient_mhlw, by = c("date")) %>% 
  tidyr::replace_na(list(dead = 0L, cum_dead = 0L, patient = 0L)) %>% 
  dplyr::mutate(diff = n - dplyr::lag(n, default = 0L),
                diff_dead = dead - dplyr::lag(dead, default = 0L),
                diff_patient = patient - dplyr::lag(patient, default = 0L)) %>% 
  dplyr::select(date, n, diff, cum, patient, diff_patient, dead, diff_dead, cum_dead)
x_mhlw
```

　  

## Visualize

```{r}
x_mhlw %>% 
  ggplot2::ggplot(ggplot2::aes(x = date)) + 
    ggplot2::geom_bar(ggplot2::aes(y = dead), stat = "identity", width = 1.0) +
    ggplot2::geom_line(ggplot2::aes(y = cum_dead / 20), colour = "dark green") +
    ggplot2::scale_y_continuous(
      name = "死者数（単日）",
      sec.axis = ggplot2::sec_axis(~ . * 20,
                                    name = "死者数累計（折線）")
    )
```

