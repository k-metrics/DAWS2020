---
title: "週番号（暦週）に関する注意事項"
output:
  html_document:
    df_print: paged
    theme: cerulean
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

```{r setup, message=FALSE, echo=FALSE}
require(tidyverse)
require(lubridate)
```


カレンダーヒートマップ（GitHubなどで使われているカレンダー形式のヒートマップ）を作成する時にハマった経験からの話。  

![例](https://i.stack.imgur.com/JKxGL.png)
　  
任意の日付が「第何週か？」を求める場合、大きく二つに分けられる。

* 当年の第何週目か？
* 当月の第何週目か？

`lubridate`パッケージを用いて第何週かを求める場合、ちょっとした注意点があるのでその紹介。  

　  

# 複数の求め方がある
年の週番号（暦週）を求める場合、複数の求め方があるので使い道に合わせて選択する。特にカレンダーを意識して週番号を求めたい場合は要注意。  


関数    | 定義      | 定義概要                              | 週初日の曜日
--------|-----------|---------------------------------------|----------------
week    | N/A       | **1月1日を第1週**とし7日単位で1を加算     | 不定         
isoweek | ISO 8601  | **最初の木曜日**を含む週が、その年の第1週 | 月曜日        
epiweek | 疫学週^1^ | 同上                                  | 日曜日（US CDC）

  
ちなみに、Googleカレンダーでは週始まりの曜日設定によりISOかEPIに自動的に切り替わる。「土曜日」始まりに設定した場合もISO/EPIの定義と同様の処理ではあるが週初日の曜日がずれる点に注意。  
　  

^1^ 疫学週（Epidemiological Week）とはCDC週とも呼ばれ、年ごとのデータの比較を可能にするために標準化された週を数える方法。残念ながら世界の地域ごとに週初日の定義が異なっていたりする。

　  

## 2009年～2010年の例
```{r}
data.frame(date = seq.Date(as.Date("2009-12-25"),
                           as.Date("2010-01-14"), by = "day")) %>% 
  dplyr::mutate(wday = lubridate::wday(date, label = TRUE),
                week = lubridate::week(date),
                isoweek = lubridate::isoweek(date),
                epiweek = lubridate::epiweek(date)) %>%
  knitr::kable()
```

　  

## 2019年～2020年の例
```{r}
data.frame(date = seq.Date(as.Date("2019-12-25"),
                           as.Date("2020-01-14"), by = "day")) %>% 
  dplyr::mutate(wday = lubridate::wday(date, label = TRUE),
                week = lubridate::week(date),
                isoweek = lubridate::isoweek(date),
                epiweek = lubridate::epiweek(date)) %>% 
  knitr::kable()
```

　  

# 月の第何週かを求める
週番号（暦週）は年単位の番号ですが、月の第何週に当たるかを計算したい時はどうすればよいでしょうか？  
　  
このような場合は、対象日と対象日が含まれる月の初日（1日）の週番号（暦週）を用いて求めます。  
　  
月の初日（1日）を求めるには`lubridate::floor_date`関数を用います。  
```{r}
date <- lubridate::today()
date
lubridate::floor_date(date, unit = "month")
```
　  
月の初日（1日）が求められましたので、その週番号（暦週）を求めるのは前述のように`lubridate`の`week`系関数を用います。  
```{r}
lubridate::floor_date(date, unit = "month") %>% 
  lubridate::epiweek()
```
　  
これで、対象日の週番号（暦週）から初日（1日）の週番号（暦週）を引いて1を加算すれば、その月の週番号が求められます。  
```{r}
lubridate::epiweek(date) - lubridate::epiweek(lubridate::floor_date(date, unit = "month")) + 1
```

　  
ただし、年末年始は週番号（暦週）がテレコになる場合がありますので、単純に1を加算するのではなくオフセットを計算して加算する必要があります。  
```{r, echo=FALSE}
offset <- function(target_week, first_week) {
  ret <- dplyr::if_else(first_week == target_week, 1,
                        dplyr::if_else(first_week == 52 | first_week > target_week, 53,
                                       dplyr::if_else(first_week == 53, 54, 1)))
  return(ret)
}
```
　  
ISO/EPIの場合は以下の条件でオフセットを求めることができます。  

条件                           | オフセット | 備考
-------------------------------|:----------:|------
月初日の週番号（暦週）が第52週 | $53$       | 各年1月のみ
月初日の週番号（暦週）が第53週 | $54$       | 同上
月初日の週番号（暦週）$\gt$ 求めたい日の週番号（暦週） | $53$ | 12月の最終週が第1週の場合
上記以外                       | $1$        | 

　  

## 2009年～2010年
```{r, echo=FALSE}
data.frame(date = seq.Date(as.Date("2009-12-25"),
                           as.Date("2010-01-14"), by = "day")) %>% 
  dplyr::mutate(wday = lubridate::wday(date, label = TRUE),
                epi = lubridate::epiweek(date),
                first_day_of_month = lubridate::floor_date(date, unit = "month"),
                fepi = lubridate::epiweek(first_day_of_month),
                weeks_of_month = epi - fepi + offset(epi, fepi)) %>% 
  knitr::kable()
```

　  

## 2019年～2020年
```{r, echo=FALSE}
data.frame(date = seq.Date(as.Date("2019-12-25"),
                           as.Date("2020-01-14"), by = "day")) %>% 
  dplyr::mutate(wday = lubridate::wday(date, label = TRUE),
                epi = lubridate::epiweek(date),
                first_day_of_month = lubridate::floor_date(date, unit = "month"),
                fepi = lubridate::epiweek(first_day_of_month),
                weeks_of_month = epi - fepi + offset(epi, fepi)) %>% 
  knitr::kable()
```

